@startuml  
title
Diagrama de Sequência - Vought Tech
 
Fluxo: Deletar Categoria (DELETE /categorias/:id)
end title

actor Admin
participant "Rota DELETE /categorias/:id" as Route
participant CategoriaController
participant CategoriaService
participant CategoriaRepository
participant ProdutoRepository
database DB

Admin -> Route: Solicita exclusão (id)
Route -> CategoriaController: deleteCategoria(req, res)
CategoriaController -> CategoriaService: deleteCategoria(id)

alt validação inicial
  alt ID não fornecido
    CategoriaService -> CategoriaController: "lança AppError (ID obrigatório)"
    CategoriaController -> Route: responde 400 - ID obrigatório
    return
  end
end

CategoriaService -> CategoriaRepository: getCategoria(id)
CategoriaRepository -> DB: SELECT id_categoria, nome FROM categorias WHERE id_categoria = $1
DB --> CategoriaRepository: categoria

alt categoria não encontrada
  CategoriaRepository --> CategoriaService: null
  CategoriaService -> CategoriaController: "lança AppError (Categoria não encontrada)"
  CategoriaController -> Route: responde 404 - Categoria não encontrada
  return
end

CategoriaRepository --> CategoriaService: categoria encontrada

CategoriaService -> ProdutoRepository: getProdutosByCategoria(id)
ProdutoRepository -> DB: SELECT * FROM produtos WHERE id_categoria = $1
DB --> ProdutoRepository: produtos vinculados

alt categoria possui produtos vinculados
  ProdutoRepository --> CategoriaService: lista com produtos (length > 0)
  CategoriaService -> CategoriaController: "lança AppError (Não é possível excluir - produtos associados)"
  CategoriaController -> Route: responde 400 - Não é possível excluir esta categoria pois ela está associada a produtos
  return
else
  ProdutoRepository --> CategoriaService: lista vazia (length = 0)
  
  CategoriaService -> CategoriaRepository: deleteCategoria(id)
  CategoriaRepository -> DB: DELETE FROM categorias WHERE id_categoria = $1 RETURNING *
  DB --> CategoriaRepository: categoria deletada
  CategoriaRepository --> CategoriaService: categoria deletada
  
  CategoriaService -> CategoriaController: retorna categoria deletada
  CategoriaController -> Route: responde 200 (categoria deletada)
  Route -> Admin: confirmação de exclusão
end

@enduml
