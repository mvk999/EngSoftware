@startuml  
title
Diagrama de Sequência - Vought Tech
 
Fluxo: Editar Pedido (PUT /pedidos/:id)
end title

actor Admin
participant "Rota PUT /pedidos/:id" as Route
participant PedidoController
participant PedidoService
participant PedidoRepository
participant ClienteRepository
participant EnderecoRepository
database DB

Admin -> Route: Envia dados (id, status, enderecoId, clienteId)
Route -> PedidoController: atualizarPedido(req, res)
PedidoController -> PedidoService: atualizarPedido(pedidoId, { status, enderecoId, clienteId })

PedidoService -> PedidoRepository: getPedido(pedidoId)
PedidoRepository -> DB: SELECT * FROM pedidos WHERE id_pedido = $1
DB --> PedidoRepository: pedido

alt pedido não encontrado
  PedidoRepository --> PedidoService: null
  PedidoService -> PedidoController: "lança AppError (Pedido não encontrado)"
  PedidoController -> Route: responde 404 - Pedido não encontrado
  return
end

PedidoRepository --> PedidoService: pedido encontrado

PedidoService -> DB: inicia transação
activate PedidoService

alt atualizar cliente (se clienteId informado)
  alt status não permite mudança de cliente
    alt pedido.status é "enviado" ou "entregue"
      PedidoService -> PedidoController: "lança AppError (Não é possível alterar cliente)"
      PedidoController -> Route: responde 400 - Não é possível alterar cliente neste status
      return
    end
  end

  PedidoService -> ClienteRepository: getCliente(clienteId)
  ClienteRepository -> DB: SELECT * FROM usuarios WHERE id_usuario = $1
  DB --> ClienteRepository: cliente

  alt cliente não encontrado
    ClienteRepository --> PedidoService: null
    PedidoService -> PedidoController: "lança AppError (Cliente não encontrado)"
    PedidoController -> Route: responde 404 - Cliente não encontrado
    return
  end

  ClienteRepository --> PedidoService: cliente encontrado
  PedidoService -> PedidoRepository: atualizarCliente(pedidoId, clienteId, trx)
  PedidoRepository -> DB: UPDATE pedidos SET id_cliente = $1 WHERE id_pedido = $2
  DB --> PedidoRepository: cliente atualizado
end

alt atualizar endereço (se enderecoId informado)
  PedidoService -> EnderecoRepository: getEndereco(enderecoId)
  EnderecoRepository -> DB: SELECT * FROM enderecos WHERE id = $1
  DB --> EnderecoRepository: endereco

  alt endereco não encontrado
    EnderecoRepository --> PedidoService: null
    PedidoService -> PedidoController: "lança AppError (Endereço não encontrado)"
    PedidoController -> Route: responde 404 - Endereço não encontrado
    return
  end

  EnderecoRepository --> PedidoService: endereco encontrado
  PedidoService -> PedidoRepository: atualizarEndereco(pedidoId, enderecoId, trx)
  PedidoRepository -> DB: UPDATE pedidos SET endereco_id = $1 WHERE id_pedido = $2
  DB --> PedidoRepository: endereco atualizado
end

alt atualizar status (se status informado)
  alt status inválido
    PedidoService -> PedidoController: "lança AppError (Status inválido)"
    PedidoController -> Route: responde 400 - Status inválido
    return
  end

  PedidoService -> PedidoRepository: atualizarStatus(pedidoId, status, trx)
  PedidoRepository -> DB: UPDATE pedidos SET status = $1 WHERE id_pedido = $2
  DB --> PedidoRepository: status atualizado
end

PedidoService -> PedidoRepository: getPedido(pedidoId, trx)
PedidoRepository -> DB: SELECT * FROM pedidos WHERE id_pedido = $1
DB --> PedidoRepository: pedido atualizado

PedidoService -> PedidoRepository: getItensPedido(pedidoId, trx)
PedidoRepository -> DB: SELECT * FROM itens_pedido WHERE id_pedido = $1
DB --> PedidoRepository: itens

deactivate PedidoService
PedidoService -> PedidoController: retorna pedido atualizado com itens
PedidoController -> Route: responde 200 (pedido atualizado)
Route -> Admin: retorna dados do pedido atualizado

@enduml
