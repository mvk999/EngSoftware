@startuml  
title
Diagrama de Sequência - Vought Tech
 
Fluxo: Atualizar Categoria (PUT /categorias/:id)
end title

actor Admin
participant "Rota PUT /categorias/:id" as Route
participant CategoriaController
participant CategoriaService
participant CategoriaRepository
database DB

Admin -> Route: Envia dados (id, nome)
Route -> CategoriaController: updateCategoria(req, res)

alt validação no controller
  alt nome inválido (< 3 caracteres)
    CategoriaController -> Route: responde 400 - Nome inválido. Mínimo 3 caracteres
    return
  end
end

CategoriaController -> CategoriaService: updateCategoria(id, nome)

alt validações iniciais do service
  alt ID não fornecido
    CategoriaService -> CategoriaController: "lança AppError (ID obrigatório)"
    CategoriaController -> Route: responde 400 - ID obrigatório
    return
  end
  
  alt nome inválido (< 3 caracteres)
    CategoriaService -> CategoriaController: "lança AppError (Nome deve ter ao menos 3 caracteres)"
    CategoriaController -> Route: responde 400 - Nome deve ter ao menos 3 caracteres
    return
  end
end

CategoriaService -> CategoriaRepository: getCategoria(id)
CategoriaRepository -> DB: SELECT id_categoria, nome FROM categorias WHERE id_categoria = $1
DB --> CategoriaRepository: categoria

alt categoria não encontrada
  CategoriaRepository --> CategoriaService: null
  CategoriaService -> CategoriaController: "lança AppError (Categoria não encontrada)"
  CategoriaController -> Route: responde 404 - Categoria não encontrada
  return
end

CategoriaRepository --> CategoriaService: categoria encontrada

CategoriaService -> CategoriaRepository: getCategoriaByNome(nome)
CategoriaRepository -> DB: SELECT id_categoria, nome FROM categorias WHERE LOWER(nome) = LOWER($1)
DB --> CategoriaRepository: categoria com mesmo nome (ou null)

alt nome já existe em outra categoria
  CategoriaRepository --> CategoriaService: categoria existente
  alt ID diferente
    CategoriaService -> CategoriaController: "lança AppError (Já existe outra categoria com esse nome)"
    CategoriaController -> Route: responde 400 - Já existe outra categoria com esse nome
    return
  end
else
  CategoriaRepository --> CategoriaService: null ou mesma categoria
  
  CategoriaService -> CategoriaRepository: updateCategoria(id, nome)
  CategoriaRepository -> DB: UPDATE categorias SET nome = $1 WHERE id_categoria = $2 RETURNING *
  DB --> CategoriaRepository: categoria atualizada
  CategoriaRepository --> CategoriaService: categoria atualizada
  
  CategoriaService -> CategoriaController: retorna categoria atualizada
  CategoriaController -> Route: responde 200 (categoria atualizada)
  Route -> Admin: retorna dados da categoria atualizada
end

@enduml
