@startuml  
title
Diagrama de Sequência - Vought Tech
 
Fluxo: Criar Pedido / Checkout (POST /pedidos)
end title

actor Cliente
participant "Rota POST /pedidos" as Route
participant PedidoController
participant PedidoService
participant CarrinhoRepository
participant ProdutoRepository
participant ClienteRepository
participant EnderecoRepository
participant PedidoRepository
database DB

Cliente -> Route: Envia pedido (enderecoId)
Route -> PedidoController: criar(req, res)
PedidoController -> PedidoService: criarPedido(clienteId, enderecoId)

alt validações iniciais
  PedidoService -> ClienteRepository: getCliente(clienteId)
  ClienteRepository -> DB: SELECT cliente
  DB --> ClienteRepository: cliente
  ClienteRepository --> PedidoService: cliente encontrado

  PedidoService -> EnderecoRepository: getEndereco(enderecoId)
  EnderecoRepository -> DB: SELECT endereco
  DB --> EnderecoRepository: endereco
  EnderecoRepository --> PedidoService: endereco encontrado

  PedidoService -> CarrinhoRepository: getCarrinho(clienteId)
  CarrinhoRepository -> DB: SELECT carrinho
  DB --> CarrinhoRepository: itens do carrinho
  CarrinhoRepository --> PedidoService: itensCarrinho
end

alt carrinho vazio
  PedidoService -> PedidoController: "lança AppError (Carrinho vazio)"
  PedidoController -> Route: responde 400 - Carrinho vazio
else
  loop validar itens
    PedidoService -> ProdutoRepository: getProduto(item.id_produto)
    ProdutoRepository -> DB: SELECT produto
    DB --> ProdutoRepository: produto
    ProdutoRepository --> PedidoService: produto

    alt estoque insuficiente
      PedidoService -> PedidoController: "lança AppError (Estoque insuficiente)"
      PedidoController -> Route: responde 400 - Estoque insuficiente
      return
    end
  end

  PedidoService -> DB: inicia transação
  activate PedidoService

  PedidoService -> PedidoRepository: criarPedido(clienteId, total, enderecoId)
  PedidoRepository -> DB: INSERT pedido
  DB --> PedidoRepository: pedido criado
  PedidoRepository --> PedidoService: retorna pedido

  loop para cada item
    PedidoService -> PedidoRepository: adicionarItemNoPedido(pedidoId, produtoId, quantidade, preco)
    PedidoRepository -> DB: INSERT item_pedido
    DB --> PedidoRepository: item inserido

    PedidoService -> ProdutoRepository: diminuirEstoque(produtoId, quantidade)
    ProdutoRepository -> DB: UPDATE estoque
    DB --> ProdutoRepository: estoque atualizado
  end

  PedidoService -> CarrinhoRepository: limparCarrinho(clienteId)
  CarrinhoRepository -> DB: DELETE carrinho
  DB --> CarrinhoRepository: carrinho limpo

  deactivate PedidoService
  PedidoService -> PedidoController: retorna pedido
  PedidoController -> Route: responde 201 (pedido criado)
end

@enduml
